<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>塔罗占卜</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定义样式，用于卡片翻转动画等 */
        :root {
            --bg-color: #261818;
            --container-bg: #1f2937;
            --input-bg: #111827;
            --text-color: #f9fafb;
            --heading-color: #fcd34d;
            --border-color: #4b5563;
        }

        body.light-theme {
            --bg-color: #f3f4f6;
            --container-bg: #ffffff;
            --input-bg: #e5e7eb;
            --text-color: #1f2937;
            --heading-color: #4f46e5;
            --border-color: #d1d5db;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        .container-bg {
            background-color: var(--container-bg);
            border-top: 2px solid var(--border-color);
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        .input-bg {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }

        .input-bg:focus {
            border-color: var(--heading-color);
        }

        .card-aspect-ratio {
            position: relative;
            width: 100%;
            padding-top: 150%; /* 2:3 宽高比 */
        }
        .perspective-1000 {
            perspective: 1000px;
        }
        .card-flip-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.7s;
            transform-style: preserve-3d;
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1rem; /* rounded-2xl */
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05); /* shadow-inner */
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .card-front {
            transform: rotateY(180deg);
        }
        .is-flipped {
            transform: rotateY(180deg);
        }
        .hidden {
            display: none;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-pulse-light {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* 在亮色模式下，直接为标题应用颜色并移除渐变背景 */
        body.light-theme .header-title-main {
            color: #2a3249; /* 低饱和度的蓝黑色 */
            background-image: none;
        }
        
        body.light-theme .text-yellow-400 { color: #6366f1; } /* indigo-500 */
        body.light-theme .text-yellow-300 { color: #4f46e5; } /* indigo-600 */
        body.light-theme .text-yellow-200 { color: #4338ca; } /* indigo-700 */
        body.light-theme .text-yellow-100\/70 { color: rgba(55, 48, 163, 0.7); } /* indigo-900 with opacity */
        body.light-theme .text-gray-300 { color: #4b5563; }
        body.light-theme .text-gray-400 { color: #6b7280; }
        body.light-theme .text-gray-200 { color: #374151; }
        body.light-theme .text-yellow-500 { color: #6366f1; }
        body.light-theme .card-back svg { color: #4f46e5; } /* 调整卡背图标颜色 */

        /* 亮色模式下，卡牌位置文字样式 */
        body.light-theme .card-position-text {
            color: #111827; /* 黑色 */
            font-size: 1.125rem; /* text-lg，比 text-sm 稍大 */
            font-weight: 600; /* semibold */
        }
    </style>
</head>
<body class="text-gray-100">

    <div class="max-w-4xl mx-auto p-4 sm:p-8 space-y-8">
        <!-- 头部 -->
        <header class="text-center">
            <div class="flex items-center justify-between">
                <div></div>
                <div class="flex-grow">
                    <h1 class="header-title-main text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 mb-2 flex items-center justify-center gap-4">
                        <i data-lucide="sparkles" class="w-8 h-8 text-yellow-400 animate-pulse-light"></i>
                        塔罗占卜
                        <i data-lucide="sparkles" class="w-8 h-8 text-yellow-400 animate-pulse-light"></i>
                    </h1>
                    <p class="text-xl text-yellow-100/70">抽取你的卡牌，探索未知的指引。</p>
                </div>
                <button id="theme-toggle-btn" class="p-2 rounded-full text-yellow-400 bg-gray-800/50 hover:bg-gray-700/50 transition-colors">
                    <i id="theme-icon" data-lucide="sun" class="w-6 h-6"></i>
                </button>
            </div>
        </header>

        <!-- 基本信息和情况输入区 -->
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- 基本信息输入区 -->
            <section class="lg:w-1/2 container-bg p-6 rounded-3xl shadow-xl">
                <h2 class="text-2xl font-semibold mb-4 text-yellow-300">你的基本信息</h2>
                <div class="space-y-4">
                    <div>
                        <label for="age-input" class="block text-sm font-medium text-gray-400 mb-1">年龄</label>
                        <input type="number" id="age-input" class="input-bg w-full p-3 rounded-xl focus:outline-none transition-colors" placeholder="请输入你的年龄" min="1">
                    </div>
                    <div>
                        <label for="gender-select" class="block text-sm font-medium text-gray-400 mb-1">性别</label>
                        <select id="gender-select" class="input-bg w-full p-3 rounded-xl focus:outline-none transition-colors">
                            <option value="保密" selected>保密</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <div>
                        <label for="occupation-input" class="block text-sm font-medium text-gray-400 mb-1">职业</label>
                        <input type="text" id="occupation-input" class="input-bg w-full p-3 rounded-xl focus:outline-none transition-colors" placeholder="请输入你的职业">
                    </div>
                    <div>
                        <label for="phone-select" class="block text-sm font-medium text-gray-400 mb-1">使用的手机</label>
                        <select id="phone-select" class="input-bg w-full p-3 rounded-xl focus:outline-none transition-colors">
                            <option value="" selected disabled>请选择</option>
                            <option value="苹果">苹果</option>
                            <option value="安卓">安卓</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- 情况输入区 -->
            <section class="lg:w-1/2 container-bg p-6 rounded-3xl shadow-xl">
                <h2 class="text-2xl font-semibold mb-4 text-yellow-300">你的近期情况</h2>
                <textarea id="situation-input" class="input-bg w-full min-h-64 p-4 rounded-xl focus:outline-none transition-colors" placeholder="例如：我最近在工作中感到有些迷茫，不知道未来的方向..."></textarea>
            </section>
        </div>

        <!-- 操作按钮 -->
        <section class="flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="draw-cards-btn" class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-gray-900 font-bold rounded-full shadow-lg hover:shadow-xl hover:from-yellow-600 hover:to-yellow-700 transition-all transform hover:scale-105 active:scale-95">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                <span id="draw-btn-text">抽取三张卡牌</span>
            </button>
            <button id="generate-reading-btn" disabled class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold rounded-full shadow-lg transition-all transform hover:scale-105 active:scale-95 cursor-not-allowed">
                <i data-lucide="sparkles" class="w-5 h-5"></i>
                <span id="reading-btn-text">开始占卜</span>
            </button>
        </section>

        <!-- 卡牌展示区 -->
        <section id="cards-section" class="container-bg p-6 rounded-3xl shadow-xl hidden">
            <h2 class="text-2xl font-semibold mb-4 text-yellow-300">你抽到的卡牌</h2>
            <div id="cards-container" class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <!-- 卡牌将由 JS 动态生成 -->
            </div>
        </section>

        <!-- 占卜结果区 -->
        <section id="reading-section" class="container-bg p-6 rounded-3xl shadow-xl hidden">
            <h2 class="text-2xl font-semibold mb-4 text-yellow-300">占卜结果</h2>
            <div id="reading-spinner" class="hidden flex items-center justify-center text-yellow-400 text-lg">
                <i data-lucide="loader-2" class="animate-spin mr-2 w-6 h-6"></i>
                正在生成占卜结果...
            </div>
            <p id="reading-result" class="whitespace-pre-wrap text-gray-300 leading-relaxed"></p>
        </section>

        <!-- 额外功能按钮区 -->
        <section id="extra-actions-section" class="hidden flex-col sm:flex-row justify-center items-center gap-4">
             <!-- 激进派解读按钮 -->
             <button id="generate-radical-btn" class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-red-500 to-rose-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 active:scale-95">
                <i data-lucide="zap" class="w-5 h-5"></i>
                <span id="radical-btn-text">生成激进派解读 ✨</span>
            </button>
            <!-- 保守派解读按钮 -->
            <button id="generate-conservative-btn" class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 active:scale-95">
                <i data-lucide="shield" class="w-5 h-5"></i>
                <span id="conservative-btn-text">生成保守派解读 ✨</span>
            </button>
        </section>

        <!-- 激进派解读区 -->
        <section id="radical-section" class="container-bg p-6 rounded-3xl shadow-xl hidden">
            <h2 class="text-3xl font-semibold mb-4 text-yellow-300">激进派解读</h2>
             <div id="radical-spinner" class="hidden flex items-center justify-center text-yellow-400 text-lg">
                <i data-lucide="loader-2" class="animate-spin mr-2 w-6 h-6"></i>
                生成中...
            </div>
            <p id="radical-result" class="whitespace-pre-wrap text-gray-300 leading-relaxed"></p>
        </section>

        <!-- 保守派解读区 -->
        <section id="conservative-section" class="container-bg p-6 rounded-3xl shadow-xl hidden">
            <h2 class="text-3xl font-semibold mb-4 text-yellow-300">保守派解读</h2>
             <div id="conservative-spinner" class="hidden flex items-center justify-center text-yellow-400 text-lg">
                <i data-lucide="loader-2" class="animate-spin mr-2 w-6 h-6"></i>
                生成中...
            </div>
            <p id="conservative-result" class="whitespace-pre-wrap text-gray-300 leading-relaxed"></p>
        </section>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 激活 Lucide 图标
            lucide.createIcons();

            // --- 数据和状态 ---
            const tarotDeck = [
                // 大阿卡纳 (Major Arcana)
                { id: 1, name: '愚人', description: '新起点、天真、冒险' }, { id: 2, name: '魔术师', description: '力量、技能、创造力、专注' }, { id: 3, name: '女祭司', description: '直觉、潜意识、神秘、被动' }, { id: 4, name: '女皇', description: '孕育、繁荣、自然、丰收' }, { id: 5, name: '皇帝', description: '权威、结构、控制、父亲' }, { id: 6, name: '教皇', description: '传统、精神指导、社会规范' }, { id: 7, name: '恋人', description: '选择、和谐、关系、价值观' }, { id: 8, name: '战车', description: '胜利、决心、控制、自我肯定' }, { id: 9, name: '力量', description: '勇气、同情、内心的力量' }, { id: 10, name: '隐士', description: '内省、独处、寻找真理' }, { id: 11, name: '命运之轮', description: '转变、循环、命运、好运' }, { id: 12, name: '正义', description: '公平、因果、真相' }, { id: 13, name: '倒吊人', description: '新的视角、牺牲、放手' }, { id: 14, name: '死神', description: '结束、转变、重生' }, { id: 15, name: '节制', description: '平衡、耐心、中庸之道' }, { id: 16, name: '恶魔', description: '诱惑、束缚、物质主义' }, { id: 17, name: '高塔', description: '灾难、剧变、彻底的改变' }, { id: 18, name: '星星', description: '希望、灵感、宁静、复苏' }, { id: 19, name: '月亮', description: '幻觉、直觉、潜意识' }, { id: 20, name: '太阳', description: '成功、幸福、活力、成就' }, { id: 21, name: '审判', description: '觉醒、呼唤、内在的审视' }, { id: 22, name: '世界', description: '圆满、完成、成功' },
                
                // 小阿卡纳 (Minor Arcana) - 权杖 (Wands)
                { id: 23, name: '权杖王牌', description: '新的开始、灵感、创造力的爆发。' },
                { id: 24, name: '权杖二', description: '计划未来、决策、个人力量。' },
                { id: 25, name: '权杖三', description: '远见、扩张、准备行动。' },
                { id: 26, name: '权杖四', description: '庆祝、和谐、家庭、稳定。' },
                { id: 27, name: '权杖五', description: '竞争、冲突、挑战。' },
                { id: 28, name: '权杖六', description: '胜利、成功、公众认可。' },
                { id: 29, name: '权杖七', description: '防御、挑战、坚持立场。' },
                { id: 30, name: '权杖八', description: '快速行动、信息、旅程。' },
                { id: 31, name: '权杖九', description: '韧性、防御、疲惫。' },
                { id: 32, name: '权杖十', description: '负担过重、责任、完成。' },
                { id: 33, name: '权杖侍卫', description: '新想法、探索、热情的信使。' },
                { id: 34, name: '权杖骑士', description: '冒险、冲动、能量、快速行动。' },
                { id: 35, name: '权杖王后', description: '热情、自信、独立、魅力。' },
                { id: 36, name: '权杖国王', description: '领导力、远见、正直、控制。' },

                // 小阿卡纳 (Minor Arcana) - 圣杯 (Cups)
                { id: 37, name: '圣杯王牌', description: '新的情感开始、爱、同情心、直觉。' },
                { id: 38, name: '圣杯二', description: '团结、伙伴关系、爱、相互吸引。' },
                { id: 39, name: '圣杯三', description: '庆祝、友谊、聚会。' },
                { id: 40, name: '圣杯四', description: '厌倦、不满足、错失良机。' },
                { id: 41, name: '圣杯五', description: '悲伤、遗憾、失落。' },
                { id: 42, name: '圣杯六', description: '过去、怀旧、天真、童年。' },
                { id: 43, name: '圣杯七', description: '幻想、选择、白日梦。' },
                { id: 44, name: '圣杯八', description: '放弃、寻找更深层的意义、旅程。' },
                { id: 45, name: '圣杯九', description: '满足、愿望达成、幸福。' },
                { id: 46, name: '圣杯十', description: '完美和谐、幸福家庭、情感满足。' },
                { id: 47, name: '圣杯侍卫', description: '情感信息、直觉、新的情感开始。' },
                { id: 48, name: '圣杯骑士', description: '浪漫、理想主义、追求梦想。' },
                { id: 49, name: '圣杯王后', description: '同情、直觉、情感支持、关爱。' },
                { id: 50, name: '圣杯国王', description: '情感成熟、控制、同情心。' },

                // 小阿卡纳 (Minor Arcana) - 宝剑 (Swords)
                { id: 51, name: '宝剑王牌', description: '新的想法、清晰的思维、突破。' },
                { id: 52, name: '宝剑二', description: '僵局、决策、逃避。' },
                { id: 53, name: '宝剑三', description: '悲伤、心碎、分离。' },
                { id: 54, name: '宝剑四', description: '休息、恢复、静思。' },
                { id: 55, name: '宝剑五', description: '冲突、失败、不光彩的胜利。' },
                { id: 56, name: '宝剑六', description: '过渡、离开困难。' },
                { id: 57, name: '宝剑七', description: '欺骗、诡计、秘密行动。' },
                { id: 58, name: '宝剑八', description: '束缚、限制、受困。' },
                { id: 59, name: '宝剑九', description: '焦虑、噩梦、担忧。' },
                { id: 60, name: '宝剑十', description: '痛苦的结束、失败、新开始。' },
                { id: 61, name: '宝剑侍卫', description: '新想法、求知欲、信使。' },
                { id: 62, name: '宝剑骑士', description: '果断、行动、急躁、直言不讳。' },
                { id: 63, name: '宝剑王后', description: '独立、聪明、锋利、直言。' },
                { id: 64, name: '宝剑国王', description: '权威、理智、公正、分析。' },

                // 小阿卡纳 (Minor Arcana) - 星币 (Pentacles)
                { id: 65, name: '星币王牌', description: '新的财务机会、富足、安全感。' },
                { id: 66, name: '星币二', description: '平衡、适应性、多任务处理。' },
                { id: 67, name: '星币三', description: '团队合作、学习、熟练。' },
                { id: 68, name: '星币四', description: '占有、控制、节俭。' },
                { id: 69, name: '星币五', description: '贫困、排斥、不安。' },
                { id: 70, name: '星币六', description: '给予和接受、慷慨、慈善。' },
                { id: 71, name: '星币七', description: '评估、耐心、等待收成。' },
                { id: 72, name: '星币八', description: '勤奋、专注、学习新技能。' },
                { id: 73, name: '星币九', description: '奢华、独立、财务自由。' },
                { id: 74, name: '星币十', description: '财富、家庭、遗产、成功。' },
                { id: 75, name: '星币侍卫', description: '新的财务机会、勤奋、学习。' },
                { id: 76, name: '星币骑士', description: '勤奋、耐心、可靠。' },
                { id: 77, name: '星币王后', description: '养育、务实、安全、富足。' },
                { id: 78, name: '星币国王', description: '成功、稳定、安全、商业头脑。' }
            ];
            let drawnCards = [];
            let situation = '';
            let age = '';
            let gender = '保密';
            let occupation = '';
            let phone = ''; // 新增的变量
            let reading = '';
            let areAllCardsRevealed = false;
            let audioContext;

            // --- DOM 元素引用 ---
            const ageInput = document.getElementById('age-input');
            const genderSelect = document.getElementById('gender-select');
            const occupationInput = document.getElementById('occupation-input');
            const phoneSelect = document.getElementById('phone-select'); // 新增的DOM元素
            const situationInput = document.getElementById('situation-input');
            const drawCardsBtn = document.getElementById('draw-cards-btn');
            const drawBtnText = document.getElementById('draw-btn-text');
            const generateReadingBtn = document.getElementById('generate-reading-btn');
            const readingBtnText = document.getElementById('reading-btn-text');
            const cardsSection = document.getElementById('cards-section');
            const cardsContainer = document.getElementById('cards-container');
            const readingSection = document.getElementById('reading-section');
            const readingSpinner = document.getElementById('reading-spinner');
            const readingResult = document.getElementById('reading-result');
            
            const extraActionsSection = document.getElementById('extra-actions-section');
            const generateRadicalBtn = document.getElementById('generate-radical-btn');
            const radicalBtnText = document.getElementById('radical-btn-text');
            const radicalSection = document.getElementById('radical-section');
            const radicalSpinner = document.getElementById('radical-spinner');
            const radicalResult = document.getElementById('radical-result');

            const generateConservativeBtn = document.getElementById('generate-conservative-btn');
            const conservativeBtnText = document.getElementById('conservative-btn-text');
            const conservativeSection = document.getElementById('conservative-section');
            const conservativeSpinner = document.getElementById('conservative-spinner');
            const conservativeResult = document.getElementById('conservative-result');

            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIcon = document.getElementById('theme-icon');

            // --- OpenRouter API 配置 ---
            // 将 apiKey 提到全局作用域，方便统一管理
            const apiKey = "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";
            const apiUrl = `https://openrouter.ai/api/v1/chat/completions`;

            // --- 音效函数 ---
            const playCardFlipSound = () => {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.15);
            };

            // --- 主题切换函数 ---
            const applyTheme = (theme) => {
                if (theme === 'light') {
                    document.body.classList.add('light-theme');
                    themeIcon.setAttribute('data-lucide', 'moon');
                } else {
                    document.body.classList.remove('light-theme');
                    themeIcon.setAttribute('data-lucide', 'sun');
                }
                lucide.createIcons(); // 重新渲染图标
            };

            // 初始化时从 localStorage 加载主题
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                applyTheme('dark'); // 默认暗色模式
            }

            // --- 核心功能函数 ---
            
            // 更新按钮状态
            const updateButtonStates = () => {
                // 抽卡按钮
                drawCardsBtn.disabled = !areAllCardsRevealed && drawnCards.length > 0;
                drawCardsBtn.classList.toggle('opacity-50', drawCardsBtn.disabled);
                drawCardsBtn.classList.toggle('cursor-not-allowed', drawCardsBtn.disabled);
                
                // 占卜按钮
                const canGenerate = areAllCardsRevealed && situation.trim() !== '' && age.trim() !== '' && occupation.trim() !== '' && gender.trim() !== '' && phone.trim() !== '';
                generateReadingBtn.disabled = !canGenerate;
                if (canGenerate) {
                    generateReadingBtn.classList.remove('from-gray-500', 'to-gray-600', 'cursor-not-allowed');
                    generateReadingBtn.classList.add('from-indigo-500', 'to-purple-600');
                } else {
                    generateReadingBtn.classList.add('from-gray-500', 'to-gray-600', 'cursor-not-allowed');
                    generateReadingBtn.classList.remove('from-indigo-500', 'to-purple-600');
                }
            };
            
            // 抽卡
            const handleDrawCards = () => {
                // 重置状态
                drawnCards = [];
                reading = '';
                areAllCardsRevealed = false;
                cardsContainer.innerHTML = '';
                readingSection.classList.add('hidden');
                radicalSection.classList.add('hidden');
                conservativeSection.classList.add('hidden');
                extraActionsSection.classList.add('hidden');
                readingResult.textContent = '';
                radicalResult.textContent = '';
                conservativeResult.textContent = '';
                drawBtnText.textContent = '重新抽取卡牌';
                updateButtonStates();

                // 洗牌
                const shuffledDeck = [...tarotDeck].sort(() => Math.random() - 0.5);
                drawnCards = shuffledDeck.slice(0, 3);
                
                cardsSection.classList.remove('hidden');

                // 创建卡牌 DOM
                drawnCards.forEach((card, index) => {
                    const cardPosition = index === 0 ? '过去' : index === 1 ? '现在' : '未来';
                    const cardHTML = `
                        <div class="relative card-aspect-ratio perspective-1000">
                            <div id="card-flipper-${index}" class="card-flip-container">
                                <!-- 卡背 -->
                                <div class="card-face card-back p-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-yellow-500">
                                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm0 15a5.25 5.25 0 1 0 0-10.5 5.25 5.25 0 0 0 0 10.5Z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <!-- 卡面 -->
                                <div class="card-face card-front p-6 space-y-2">
                                    <p class="card-position-text text-sm text-yellow-400/80 uppercase tracking-widest">${cardPosition}</p>
                                    <h3 class="text-3xl font-bold text-yellow-200">${card.name}</h3>
                                    <p class="text-gray-400 text-sm">${card.description}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    cardsContainer.innerHTML += cardHTML;
                });

                // 逐一翻转卡牌
                drawnCards.forEach((_, index) => {
                    setTimeout(() => {
                        playCardFlipSound();
                        document.getElementById(`card-flipper-${index}`).classList.add('is-flipped');
                        if (index === drawnCards.length - 1) {
                            areAllCardsRevealed = true;
                            updateButtonStates();
                        }
                    }, (index + 1) * 700);
                });
            };

            // 通用 API 调用函数，增强了错误处理
            const callGenerativeAPI = async (prompt) => {
                try {
                    const payload = {
                        model: "deepseek/deepseek-chat-v3-0324:free", // 更新为指定的免费模型
                        messages: [{ role: "user", content: prompt }],
                        stream: false,
                    };
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`,
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        if (errorData && errorData.error && errorData.error.message) {
                            console.error('API call failed with detailed error:', errorData.error.message);
                            throw new Error(`API error: ${errorData.error.message}`);
                        } else {
                            console.error('API call failed with status:', response.status);
                            throw new Error(`API error: ${response.statusText || '服务器返回了错误状态码，但没有提供详细信息。'}`);
                        }
                    }

                    const result = await response.json();
                    
                    if (result.choices && result.choices.length > 0 && result.choices[0].message?.content) {
                        return result.choices[0].message.content;
                    } else {
                        throw new Error('API did not return valid content.');
                    }
                } catch (error) {
                    console.error('API call failed:', error);
                    return `请求失败：${error.message}`;
                }
            };

            // 生成占卜结果
            const handleGenerateReading = async () => {
                // 检查所有必填字段是否已填写
                if (!areAllCardsRevealed || situation.trim() === '' || age.trim() === '' || occupation.trim() === '' || gender.trim() === '' || phone.trim() === '') {
                    const message = '请填写所有必填信息并抽取卡牌以开始占卜。';
                    const modal = document.createElement('div');
                    modal.innerHTML = `<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;"><div style="background:#1f2937;color:#f9fafb;padding:24px;border-radius:12px;text-align:center;box-shadow:0 10px 15px rgba(0,0,0,0.2);"><p class="text-lg">${message}</p><button onclick="this.parentNode.parentNode.remove()" class="mt-4 px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold rounded-full transition-colors">确认</button></div></div>`;
                    document.body.appendChild(modal);
                    return;
                }

                readingSection.classList.remove('hidden');
                readingSpinner.classList.remove('hidden');
                readingResult.textContent = '';
                generateReadingBtn.disabled = true;
                readingBtnText.textContent = '正在生成...';
                
                const prompt = `你是一位专业的塔罗牌占卜师。请根据以下信息为我进行一次占卜：

- 我的基本信息：
年龄：${age}
性别：${gender}
职业：${occupation}
使用的手机：${phone}
- 我的近期情况：${situation}
- 我抽到的塔罗牌：
过去：${drawnCards[0].name} (${drawnCards[0].description})
现在：${drawnCards[1].name} (${drawnCards[1].description})
未来：${drawnCards[2].name} (${drawnCards[2].description})

请结合我的情况、基本信息和塔罗牌的寓意，以富有洞察力、温暖且专业的口吻，为我提供一个详细的解读和建议。请只生成中文文本，并且不要使用任何Markdown格式（例如粗体或标题）。`;

                reading = await callGenerativeAPI(prompt);
                
                readingSpinner.classList.add('hidden');
                readingResult.textContent = reading;
                readingBtnText.textContent = '开始占卜';
                generateReadingBtn.disabled = false;
                extraActionsSection.style.display = 'flex'; // 显示额外按钮
            };
            
            // 生成激进派解读
            const handleGenerateRadical = async () => {
                radicalSection.classList.remove('hidden');
                radicalSpinner.classList.remove('hidden');
                radicalResult.textContent = '';
                generateRadicalBtn.disabled = true;
                radicalBtnText.textContent = '生成中...';

                const prompt = `你是一位专业的塔罗牌占卜师，以激进派视角解读。请根据以下用户的近期情况和塔罗牌占卜结果，提供一个大胆、非传统、鼓励跳出舒适区的解读和行动建议。请只生成中文文本，并且不要使用任何Markdown格式（例如粗体或标题）。用户情况：${situation}。占卜结果：${reading}`;
                
                const result = await callGenerativeAPI(prompt);

                radicalSpinner.classList.add('hidden');
                radicalResult.textContent = result;
                radicalBtnText.innerHTML = '生成激进派解读 ✨';
                generateRadicalBtn.disabled = false;
            };

            // 生成保守派解读
            const handleGenerateConservative = async () => {
                conservativeSection.classList.remove('hidden');
                conservativeSpinner.classList.remove('hidden');
                conservativeResult.textContent = '';
                generateConservativeBtn.disabled = true;
                conservativeBtnText.textContent = '生成中...';

                const prompt = `你是一位专业的塔罗牌占卜师，以保守派视角解读。请根据以下用户的近期情况和塔罗牌占卜结果，提供一个稳健、谨慎、鼓励按部就班和遵循传统的解读和行动建议。请只生成中文文本，并且不要使用任何Markdown格式（例如粗体或标题）。用户情况：${situation}。占卜结果：${reading}`;

                const result = await callGenerativeAPI(prompt);
                
                conservativeSpinner.classList.add('hidden');
                conservativeResult.textContent = result;
                conservativeBtnText.innerHTML = '生成保守派解读 ✨';
                generateConservativeBtn.disabled = false;
            };


            // --- 事件监听器 ---
            ageInput.addEventListener('input', (e) => {
                age = e.target.value;
                updateButtonStates();
            });
            genderSelect.addEventListener('change', (e) => {
                gender = e.target.value;
                updateButtonStates();
            });
            occupationInput.addEventListener('input', (e) => {
                occupation = e.target.value;
                updateButtonStates();
            });
            phoneSelect.addEventListener('change', (e) => {
                phone = e.target.value;
                updateButtonStates();
            });
            situationInput.addEventListener('input', (e) => {
                situation = e.target.value;
                updateButtonStates();
            });
            drawCardsBtn.addEventListener('click', handleDrawCards);
            generateReadingBtn.addEventListener('click', handleGenerateReading);
            generateRadicalBtn.addEventListener('click', handleGenerateRadical);
            generateConservativeBtn.addEventListener('click', handleGenerateConservative);
            
            themeToggleBtn.addEventListener('click', () => {
                if (document.body.classList.contains('light-theme')) {
                    applyTheme('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    applyTheme('light');
                    localStorage.setItem('theme', 'light');
                }
            });

            // 初始化按钮状态
            updateButtonStates();
        });
    </script>
</body>
</html>
